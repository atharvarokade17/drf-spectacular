version: 2.1

jobs:
  build:
    docker:
      - image: cimg/python:3.10  
    steps:
      - checkout
      - add_ssh_keys:
          fingerprints:
            - $GITHUB_SSH_FINGERPRINT
      - run:
          name: Set up Python
          command: |
            python -m venv venv
            . venv/bin/activate
            pip install --upgrade pip
            pip install -r requirements.txt
      - run:
          name: Migrate Database
          command: |
            . venv/bin/activate
            python manage.py migrate
      - run:
          name: Generate schema.yaml
          command: |
            . venv/bin/activate
            python manage.py spectacular --file schema.yaml
      - run:
          name: Copy schema.yaml to EC2
          command: |
            ssh -o StrictHostKeyChecking=no ubuntu@$EC2_HOST "mkdir -p /home/ubuntu/swagger"
            scp -o StrictHostKeyChecking=no schema.yaml ubuntu@$EC2_HOST:/home/ubuntu/swagger/schema.yaml
      - run:
          name: Start Swagger UI
          command: |
            ssh -o StrictHostKeyChecking=no ubuntu@$EC2_HOST "
              docker rm -f swagger-ui || true &&
              docker run -d -p 8080:8080 \
                -e SWAGGER_JSON=/schema.yaml \
                -v /home/ubuntu/swagger/schema.yaml:/schema.yaml \
                --name swagger-ui \
                swaggerapi/swagger-ui
            "

workflows:
  version: 2
  generate-and-deploy-schema:
    jobs:
      - build