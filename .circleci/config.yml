version: 2.1

orbs:
  aws-cli: circleci/aws-cli@5.4.1

jobs:
  generate-and-deploy-schema:
    executor: aws-cli/default
    steps:
      - checkout
      - aws-cli/setup   
      - run:
          name: Set up Dev Environment & Generate Schema
          command: make dev
      - run:
          name: Copy schema.yaml to EC2 via SSM
          command: |
            FILE_CONTENT=$(base64 -w 0 schema.yaml)
            aws ssm send-command \
              --targets "Key=instanceIds,Values=$EC2_INSTANCE_ID" \
              --document-name "AWS-RunShellScript" \
              --comment "Write schema.yaml" \
              --parameters 'commands=[
                "mkdir -p /home/ubuntu/swagger",
                "echo '$FILE_CONTENT' | base64 -d > /home/ubuntu/swagger/schema.yaml"
              ]'
      - run:
          name: Start Swagger UI via SSM
          command: |
            aws ssm send-command \
              --targets "Key=instanceIds,Values=$EC2_INSTANCE_ID" \
              --document-name "AWS-RunShellScript" \
              --comment "Run Swagger UI in Docker" \
              --parameters 'commands=[
                "docker rm -f swagger-ui || true",
                "docker run -d -p 8080:8080 \
                  -e SWAGGER_JSON=/schema.yaml \
                  -v /home/ubuntu/swagger/schema.yaml:/schema.yaml \
                  --name swagger-ui \
                  swaggerapi/swagger-ui"
              ]'

workflows:
  version: 2
  deploy-swagger-ui:
    jobs:
      - generate-and-deploy-schema